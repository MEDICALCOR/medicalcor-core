#!/bin/bash
#
# Pre-push hook to prevent direct pushes to protected branches
# Part of MedicalCor Triple-Guard System
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Protected branches - add more as needed
PROTECTED_BRANCHES=("main" "master" "production" "staging")

# Get current branch
CURRENT_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)

# Get the remote and branch being pushed to
while read local_ref local_sha remote_ref remote_sha; do
    # Extract branch name from remote ref
    REMOTE_BRANCH=$(echo "$remote_ref" | sed 's|refs/heads/||')

    for protected in "${PROTECTED_BRANCHES[@]}"; do
        if [ "$REMOTE_BRANCH" = "$protected" ]; then
            echo -e "${RED}========================================${NC}"
            echo -e "${RED}  PUSH BLOCKED!${NC}"
            echo -e "${RED}========================================${NC}"
            echo ""
            echo -e "${YELLOW}You attempted to push directly to '${protected}'${NC}"
            echo ""
            echo "Direct pushes to protected branches are not allowed."
            echo ""
            echo -e "${GREEN}CORRECT WORKFLOW:${NC}"
            echo "  1. Create a feature branch:"
            echo "     git checkout -b feature/your-feature-name"
            echo ""
            echo "  2. Make your changes and commit"
            echo ""
            echo "  3. Push your feature branch:"
            echo "     git push -u origin feature/your-feature-name"
            echo ""
            echo "  4. Create a Pull Request on GitHub"
            echo ""
            echo "  5. Get code review and approval"
            echo ""
            echo "  6. Merge via GitHub (not git push!)"
            echo ""
            echo -e "${YELLOW}See docs/GIT_WORKFLOW.md for full details${NC}"
            echo -e "${RED}========================================${NC}"
            exit 1
        fi
    done
done

echo -e "${GREEN}Pre-push check passed${NC}"
exit 0
