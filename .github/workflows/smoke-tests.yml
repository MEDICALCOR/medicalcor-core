name: Smoke Tests

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        type: string
      base_url:
        description: 'Base URL of the deployed service'
        required: true
        type: string
    outputs:
      passed:
        description: 'Whether smoke tests passed'
        value: ${{ jobs.smoke-tests.outputs.passed }}
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - staging
          - production
      base_url:
        description: 'Base URL (leave empty for default)'
        required: false
        type: string

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9.14.2'

permissions:
  contents: read

jobs:
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    outputs:
      passed: ${{ steps.results.outputs.passed }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Determine base URL
        id: url
        run: |
          if [ -n "${{ inputs.base_url }}" ]; then
            BASE_URL="${{ inputs.base_url }}"
          else
            case "${{ inputs.environment }}" in
              staging)
                BASE_URL="https://staging-api.medicalcor.ro"
                ;;
              production)
                BASE_URL="https://api.medicalcor.ro"
                ;;
              *)
                BASE_URL="http://localhost:3000"
                ;;
            esac
          fi
          echo "base_url=$BASE_URL" >> $GITHUB_OUTPUT

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30

      # =============================================================================
      # Health Checks
      # =============================================================================
      - name: Health endpoint check
        id: health
        run: |
          URL="${{ steps.url.outputs.base_url }}/health"
          echo "Testing: $URL"

          RESPONSE=$(curl -sf -w "\n%{http_code}" "$URL" || echo -e "\n000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Health check passed"
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "response=$BODY" >> $GITHUB_OUTPUT
          else
            echo "âŒ Health check failed with status $HTTP_CODE"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Readiness check
        id: readiness
        run: |
          URL="${{ steps.url.outputs.base_url }}/health/ready"
          echo "Testing: $URL"

          # Allow some retries for readiness
          for i in {1..5}; do
            RESPONSE=$(curl -sf -w "\n%{http_code}" "$URL" || echo -e "\n000")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
            
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "âœ… Readiness check passed"
              echo "passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "Readiness check attempt $i failed, retrying in 10s..."
            sleep 10
          done

          echo "âŒ Readiness check failed"
          echo "passed=false" >> $GITHUB_OUTPUT
          exit 1

      - name: Liveness check
        id: liveness
        run: |
          URL="${{ steps.url.outputs.base_url }}/health/live"
          echo "Testing: $URL"

          RESPONSE=$(curl -sf -w "\n%{http_code}" "$URL" || echo -e "\n000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Liveness check passed"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Liveness check failed with status $HTTP_CODE"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      # =============================================================================
      # API Smoke Tests
      # =============================================================================
      - name: API version check
        id: version
        continue-on-error: true
        run: |
          URL="${{ steps.url.outputs.base_url }}/api/version"
          echo "Testing: $URL"

          RESPONSE=$(curl -sf -w "\n%{http_code}" "$URL" || echo -e "\n000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Version endpoint accessible"
            echo "Version: $BODY"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Version endpoint returned $HTTP_CODE (non-critical)"
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

      - name: OpenAPI/Swagger docs check
        id: docs
        continue-on-error: true
        run: |
          URL="${{ steps.url.outputs.base_url }}/documentation/json"
          echo "Testing: $URL"

          RESPONSE=$(curl -sf -w "\n%{http_code}" "$URL" || echo -e "\n000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… API documentation accessible"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ API documentation returned $HTTP_CODE (non-critical)"
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

      # =============================================================================
      # Security Checks
      # =============================================================================
      - name: Security headers check
        id: security-headers
        run: |
          URL="${{ steps.url.outputs.base_url }}/health"
          echo "Testing security headers at: $URL"

          HEADERS=$(curl -sI "$URL" || true)

          PASSED=true
          MISSING=""

          # Check for important security headers
          if ! echo "$HEADERS" | grep -qi "X-Content-Type-Options"; then
            MISSING="${MISSING}X-Content-Type-Options, "
          fi

          if ! echo "$HEADERS" | grep -qi "X-Frame-Options\|Content-Security-Policy"; then
            MISSING="${MISSING}X-Frame-Options or CSP, "
          fi

          if ! echo "$HEADERS" | grep -qi "Strict-Transport-Security"; then
            # Only warn in production
            if [ "${{ inputs.environment }}" == "production" ]; then
              MISSING="${MISSING}Strict-Transport-Security, "
            fi
          fi

          if [ -n "$MISSING" ]; then
            echo "âš ï¸ Missing security headers: ${MISSING%%, }"
            echo "warnings=${MISSING%%, }" >> $GITHUB_OUTPUT
          else
            echo "âœ… All security headers present"
          fi

          echo "passed=true" >> $GITHUB_OUTPUT

      - name: CORS check
        id: cors
        continue-on-error: true
        run: |
          URL="${{ steps.url.outputs.base_url }}/health"
          echo "Testing CORS at: $URL"

          RESPONSE=$(curl -sI -H "Origin: https://malicious-site.com" "$URL" || true)

          if echo "$RESPONSE" | grep -qi "Access-Control-Allow-Origin: \*"; then
            echo "âš ï¸ Warning: Wildcard CORS detected"
            echo "passed=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… CORS configuration appears secure"
            echo "passed=true" >> $GITHUB_OUTPUT
          fi

      # =============================================================================
      # Performance Checks
      # =============================================================================
      - name: Response time check
        id: performance
        run: |
          URL="${{ steps.url.outputs.base_url }}/health"
          echo "Testing response time at: $URL"

          # Make 5 requests and calculate average
          TOTAL=0
          for i in {1..5}; do
            TIME=$(curl -sf -o /dev/null -w "%{time_total}" "$URL" || echo "5")
            TIME_MS=$(awk "BEGIN {print int($TIME * 1000)}")
            TOTAL=$((TOTAL + TIME_MS))
            echo "Request $i: ${TIME_MS}ms"
          done

          AVG=$((TOTAL / 5))
          echo "Average response time: ${AVG}ms"

          # Threshold: 500ms for health endpoint
          if [ "$AVG" -lt 500 ]; then
            echo "âœ… Response time acceptable (${AVG}ms < 500ms)"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Response time slow (${AVG}ms >= 500ms)"
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

          echo "avg_ms=$AVG" >> $GITHUB_OUTPUT

      # =============================================================================
      # Database Connectivity (via health check)
      # =============================================================================
      - name: Database connectivity check
        id: database
        run: |
          URL="${{ steps.url.outputs.base_url }}/health"
          echo "Checking database connectivity via health endpoint..."

          RESPONSE=$(curl -sf "$URL" || echo '{"database": "unknown"}')

          if echo "$RESPONSE" | grep -qi '"database".*"healthy\|connected\|ok"'; then
            echo "âœ… Database connectivity confirmed"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Unable to confirm database connectivity from health response"
            echo "passed=true" >> $GITHUB_OUTPUT  # Non-critical if endpoint works
          fi

      # =============================================================================
      # Results Summary
      # =============================================================================
      - name: Collect results
        id: results
        if: always()
        run: |
          echo "## Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Base URL:** ${{ steps.url.outputs.base_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Health | ${{ steps.health.outputs.passed == 'true' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Readiness | ${{ steps.readiness.outputs.passed == 'true' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Liveness | ${{ steps.liveness.outputs.passed == 'true' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version.outputs.passed == 'true' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Docs | ${{ steps.docs.outputs.passed == 'true' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Headers | ${{ steps.security-headers.outputs.passed == 'true' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CORS | ${{ steps.cors.outputs.passed == 'true' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance (${steps.performance.outputs.avg_ms}ms) | ${{ steps.performance.outputs.passed == 'true' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Database | ${{ steps.database.outputs.passed == 'true' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY

          # Critical checks must pass
          if [ "${{ steps.health.outputs.passed }}" != "true" ] || \
             [ "${{ steps.readiness.outputs.passed }}" != "true" ] || \
             [ "${{ steps.liveness.outputs.passed }}" != "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**âŒ CRITICAL CHECKS FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**âœ… All critical checks passed**" >> $GITHUB_STEP_SUMMARY
            echo "passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Notify on failure
        if: failure()
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
        with:
          payload: |
            {
              "text": "ðŸš¨ Smoke Tests Failed: ${{ inputs.environment }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ðŸš¨ Smoke Tests Failed*\n*Environment:* `${{ inputs.environment }}`\n*URL:* ${{ steps.url.outputs.base_url }}\n*Workflow:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true
