# Manual repository audit workflow
# Runs typecheck, lint, tests, build, security audit, and secret scanning

name: Repository Audit

on:
  workflow_dispatch:
    inputs:
      run_claude:
        description: 'Run Claude CLI analysis (requires CLAUDE_API_KEY secret)'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10.24.0'

permissions:
  contents: read
  security-events: write

jobs:
  # =============================================================================
  # Quality Checks
  # =============================================================================
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript typecheck
        run: pnpm typecheck

      - name: Run ESLint
        run: pnpm lint

      - name: Run tests
        run: pnpm test

      - name: Build
        run: pnpm build

  # =============================================================================
  # Security Audit
  # =============================================================================
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        run: |
          pnpm audit --json > pnpm-audit.json || true
          echo "## pnpm Audit Results" >> $GITHUB_STEP_SUMMARY
          node -e "
            const fs = require('fs');
            try {
              const audit = JSON.parse(fs.readFileSync('pnpm-audit.json', 'utf8'));
              const meta = audit.metadata?.vulnerabilities || {};
              console.log('| Severity | Count |');
              console.log('|----------|-------|');
              console.log('| Critical | ' + (meta.critical || 0) + ' |');
              console.log('| High | ' + (meta.high || 0) + ' |');
              console.log('| Moderate | ' + (meta.moderate || 0) + ' |');
              console.log('| Low | ' + (meta.low || 0) + ' |');
            } catch(e) { console.log('Unable to parse audit results'); }
          " >> $GITHUB_STEP_SUMMARY

      - name: Upload pnpm audit report
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: pnpm-audit
          path: pnpm-audit.json
          retention-days: 30

  # =============================================================================
  # Secrets Scanning
  # =============================================================================
  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install gitleaks
        run: |
          GITLEAKS_VERSION="8.21.2"
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" | tar -xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run gitleaks scan
        run: |
          gitleaks detect --source . --config .gitleaks.toml --report-format json --report-path gitleaks-report.json || true
          echo "## Secrets Scan Results" >> $GITHUB_STEP_SUMMARY
          if [ -f gitleaks-report.json ]; then
            FINDINGS=$(node -e "const r=require('./gitleaks-report.json'); console.log(Array.isArray(r) ? r.length : 0);" 2>/dev/null || echo "0")
            if [ "$FINDINGS" -gt 0 ]; then
              echo "**⚠️ Found $FINDINGS potential secrets**" >> $GITHUB_STEP_SUMMARY
            else
              echo "**✅ No secrets detected**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**✅ No secrets detected**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload gitleaks report
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: always()
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30

  # =============================================================================
  # CodeQL Analysis
  # =============================================================================
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Initialize CodeQL
        uses: github/codeql-action/init@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # v4.31.7
        with:
          languages: javascript-typescript

      - name: Autobuild
        uses: github/codeql-action/autobuild@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # v4.31.7

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # v4.31.7

  # =============================================================================
  # Claude CLI Analysis (Optional)
  # =============================================================================
  claude-analysis:
    name: Claude CLI Analysis
    runs-on: ubuntu-latest
    if: inputs.run_claude == 'true' && github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for Claude API Key
        id: check-key
        run: |
          if [ -n "${{ secrets.CLAUDE_API_KEY }}" ]; then
            echo "has_key=true" >> $GITHUB_OUTPUT
          else
            echo "has_key=false" >> $GITHUB_OUTPUT
            echo "## Claude Analysis" >> $GITHUB_STEP_SUMMARY
            echo "**⏭️ Skipped:** CLAUDE_API_KEY secret not configured" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run Claude CLI analysis
        if: steps.check-key.outputs.has_key == 'true'
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          echo "Claude CLI analysis placeholder"
          echo '{"status": "placeholder", "message": "Claude CLI integration pending"}' > claude-report.json

      - name: Upload Claude report
        if: steps.check-key.outputs.has_key == 'true'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: claude-report
          path: claude-report.json
          retention-days: 30
