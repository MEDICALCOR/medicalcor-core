# Repository Audit Workflow
# Comprehensive automated audit including security scanning, dependency checks,
# code quality analysis, and optional AI-powered code review

name: Repository Audit

on:
  workflow_dispatch:
    inputs:
      run_claude_analysis:
        description: 'Run Claude Code analysis (requires CLAUDE_API_KEY secret)'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9.14.2'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # =============================================================================
  # Comprehensive Repository Audit
  # =============================================================================
  audit:
    name: Repository Audit
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      # -------------------------------------------------------------------------
      # Checkout with full history for comprehensive analysis
      # -------------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0  # Full history for comprehensive audit
          token: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------------------------------------------------------
      # Setup Node.js with Corepack and pnpm
      # -------------------------------------------------------------------------
      - name: Enable Corepack
        run: corepack enable

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # -------------------------------------------------------------------------
      # Install dependencies
      # -------------------------------------------------------------------------
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # -------------------------------------------------------------------------
      # Code quality checks
      # -------------------------------------------------------------------------
      - name: Run typecheck
        id: typecheck
        run: |
          echo "## TypeScript Type Checking" >> $GITHUB_STEP_SUMMARY
          pnpm -w -r run typecheck --if-present 2>&1 | tee typecheck-output.log || {
            EXIT_CODE=$?
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**âš ï¸ Type checking found issues** (exit code: $EXIT_CODE)" >> $GITHUB_STEP_SUMMARY
            exit $EXIT_CODE
          }
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Type checking passed" >> $GITHUB_STEP_SUMMARY

      - name: Run lint
        id: lint
        run: |
          echo "## ESLint Code Quality" >> $GITHUB_STEP_SUMMARY
          pnpm -w -r run lint --if-present 2>&1 | tee lint-output.log || {
            EXIT_CODE=$?
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**âš ï¸ Linting found issues** (exit code: $EXIT_CODE)" >> $GITHUB_STEP_SUMMARY
            exit $EXIT_CODE
          }
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Linting passed" >> $GITHUB_STEP_SUMMARY

      - name: Run tests
        id: test
        run: |
          echo "## Test Suite Execution" >> $GITHUB_STEP_SUMMARY
          pnpm -w -r run test --if-present 2>&1 | tee test-output.log || {
            EXIT_CODE=$?
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**âš ï¸ Tests failed** (exit code: $EXIT_CODE)" >> $GITHUB_STEP_SUMMARY
            exit $EXIT_CODE
          }
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Tests passed" >> $GITHUB_STEP_SUMMARY

      - name: Run build
        id: build
        run: |
          echo "## Build Process" >> $GITHUB_STEP_SUMMARY
          pnpm -w -r run build --if-present 2>&1 | tee build-output.log || {
            EXIT_CODE=$?
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**âš ï¸ Build failed** (exit code: $EXIT_CODE)" >> $GITHUB_STEP_SUMMARY
            exit $EXIT_CODE
          }
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY

      # -------------------------------------------------------------------------
      # Dependency vulnerability audit
      # -------------------------------------------------------------------------
      - name: Run pnpm audit
        id: pnpm_audit
        continue-on-error: true
        run: |
          echo "## Dependency Vulnerability Audit" >> $GITHUB_STEP_SUMMARY
          pnpm audit --json > pnpm-audit.json 2>&1 || true
          
          # Parse vulnerability counts
          CRITICAL=$(node -e "try { const r=require('./pnpm-audit.json'); console.log(r.metadata?.vulnerabilities?.critical || 0); } catch { console.log(0); }")
          HIGH=$(node -e "try { const r=require('./pnpm-audit.json'); console.log(r.metadata?.vulnerabilities?.high || 0); } catch { console.log(0); }")
          MODERATE=$(node -e "try { const r=require('./pnpm-audit.json'); console.log(r.metadata?.vulnerabilities?.moderate || 0); } catch { console.log(0); }")
          LOW=$(node -e "try { const r=require('./pnpm-audit.json'); console.log(r.metadata?.vulnerabilities?.low || 0); } catch { console.log(0); }")
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ  High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”µ Low | $LOW |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**âš ï¸ Critical or High severity vulnerabilities detected!**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload pnpm audit report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: pnpm-audit-report
          path: pnpm-audit.json
          retention-days: 30

      # -------------------------------------------------------------------------
      # Secret scanning with Gitleaks
      # -------------------------------------------------------------------------
      - name: Run gitleaks secret scan
        id: gitleaks
        uses: zricethezav/gitleaks-action@4.1.1
        continue-on-error: true
        with:
          args: --config=.gitleaks.toml --report-format=json --report-path=gitleaks-report.json --redact --verbose

      - name: Process gitleaks results
        if: always()
        run: |
          echo "## Secret Scanning Results" >> $GITHUB_STEP_SUMMARY
          if [ -f "gitleaks-report.json" ]; then
            LEAKS_COUNT=$(node -e "try { const r=require('./gitleaks-report.json'); console.log(Array.isArray(r) ? r.length : 0); } catch { console.log(0); }")
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Potential secrets detected:** $LEAKS_COUNT" >> $GITHUB_STEP_SUMMARY
            if [ "$LEAKS_COUNT" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Action Required:** Review the gitleaks-report.json artifact for details" >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… No secrets detected" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… No secrets detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload gitleaks report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          if-no-files-found: ignore
          retention-days: 30

      # -------------------------------------------------------------------------
      # CodeQL security analysis
      # -------------------------------------------------------------------------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@fe4161a26a8629af62121b670040955b330f9af2 # v4.31.6
        with:
          languages: javascript-typescript
          queries: security-extended,security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@fe4161a26a8629af62121b670040955b330f9af2 # v4.31.6
        with:
          category: "/language:javascript-typescript"
          output: sarif-results
          upload: true

      - name: CodeQL results summary
        if: always()
        run: |
          echo "## CodeQL Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… CodeQL analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Results are available in the Security tab under Code scanning alerts" >> $GITHUB_STEP_SUMMARY

      # -------------------------------------------------------------------------
      # Optional: Claude Code AI analysis
      # -------------------------------------------------------------------------
      - name: Claude Code Analysis (Optional)
        id: claude_analysis
        if: |
          (github.event.inputs.run_claude_analysis == 'true' || github.event.inputs.run_claude_analysis == true) &&
          secrets.CLAUDE_API_KEY != ''
        continue-on-error: true
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          echo "## Claude Code AI Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ¤– Running Claude-powered code analysis..." >> $GITHUB_STEP_SUMMARY
          
          # Placeholder for Claude Code CLI command
          # Replace this with the actual Claude Code analysis command when available
          # Example: claude-code analyze --output claude-report.json
          
          # For now, create a placeholder report
          echo '{"status":"placeholder","message":"Claude Code analysis is configured but the CLI command needs to be implemented","timestamp":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'","configuration":{"api_key_configured":true,"analysis_type":"full_repository_audit"},"next_steps":["Install Claude Code CLI tool","Configure analysis parameters","Execute analysis command","Parse and upload results"]}' > claude-report.json
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Claude Code analysis placeholder executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Implement the actual Claude Code CLI command in this step" >> $GITHUB_STEP_SUMMARY

      - name: Skip Claude Code Analysis
        if: |
          (github.event.inputs.run_claude_analysis != 'true' && github.event.inputs.run_claude_analysis != true) ||
          secrets.CLAUDE_API_KEY == ''
        run: |
          echo "## Claude Code AI Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.run_claude_analysis }}" == "true" ]; then
            echo "âš ï¸ Skipped - CLAUDE_API_KEY secret not configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ Skipped - Not requested in workflow inputs" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Claude analysis report
        if: |
          always() &&
          (github.event.inputs.run_claude_analysis == 'true' || github.event.inputs.run_claude_analysis == true) &&
          secrets.CLAUDE_API_KEY != ''
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: claude-analysis-report
          path: claude-report.json
          if-no-files-found: ignore
          retention-days: 30

      # -------------------------------------------------------------------------
      # Upload all logs and reports
      # -------------------------------------------------------------------------
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: audit-logs
          path: |
            typecheck-output.log
            lint-output.log
            test-output.log
            build-output.log
          if-no-files-found: ignore
          retention-days: 14

      # -------------------------------------------------------------------------
      # Final audit summary
      # -------------------------------------------------------------------------
      - name: Audit completion summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Audit Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow run:** [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts available:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ pnpm-audit-report" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ gitleaks-report (if secrets detected)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ audit-logs (typecheck, lint, test, build)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.run_claude_analysis }}" == "true" ]; then
            echo "- ðŸ¤– claude-analysis-report (if configured)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CodeQL results:** Check the [Security tab](/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
