# k6 Load Testing CI Workflow
# Automates k6 load tests for performance regression detection and API validation
#
# Triggers:
#   - PRs affecting API code: smoke tests for fast feedback
#   - Main branch push: load tests for thorough validation
#   - Manual: any scenario with configurable parameters
#   - Scheduled: weekly load tests on main

name: k6 Load Tests

on:
  push:
    branches: [main]
    paths:
      - 'apps/api/**'
      - 'packages/**'
      - 'scripts/k6/**'
  pull_request:
    branches: [main]
    paths:
      - 'apps/api/**'
      - 'packages/**'
      - 'scripts/k6/**'
  schedule:
    # Run load tests weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      scenario:
        description: 'Test scenario (smoke, load, stress, soak)'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - load
          - stress
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - api
          - rls
      base_url:
        description: 'Base URL for testing (leave empty for local)'
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10.24.0'
  K6_VERSION: '0.54.0'
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

permissions:
  contents: read
  pull-requests: write

jobs:
  # =============================================================================
  # Changes Detection
  # =============================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      k6: ${{ steps.filter.outputs.k6 }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Filter paths
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            api:
              - 'apps/api/**'
              - 'packages/**'
            k6:
              - 'scripts/k6/**'

  # =============================================================================
  # API Load Tests (General)
  # =============================================================================
  api-load-test:
    name: API Load Test (${{ matrix.scenario }})
    runs-on: ubuntu-latest
    needs: [changes]
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      needs.changes.outputs.api == 'true' ||
      needs.changes.outputs.k6 == 'true'
    strategy:
      fail-fast: false
      matrix:
        # On PR: smoke only; on main/schedule/manual: configurable
        scenario:
          - ${{ github.event_name == 'pull_request' && 'smoke' || github.event.inputs.scenario || 'load' }}
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: medicalcor_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install k6
        run: |
          curl -fsSL https://github.com/grafana/k6/releases/download/v${{ env.K6_VERSION }}/k6-v${{ env.K6_VERSION }}-linux-amd64.tar.gz | tar -xz
          sudo mv k6-v${{ env.K6_VERSION }}-linux-amd64/k6 /usr/local/bin/
          k6 version

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build API
        run: pnpm --filter @medicalcor/api build
        env:
          NODE_ENV: production

      - name: Start API server
        run: |
          cd apps/api
          pnpm start &
          echo "Waiting for API to start..."
          timeout 60 bash -c 'until curl -s http://localhost:3000/health > /dev/null 2>&1; do sleep 1; done'
          echo "API is ready"
        env:
          NODE_ENV: production
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/medicalcor_test
          REDIS_URL: redis://localhost:6379
          API_SECRET_KEY: test-api-key
          ALLOW_UNVERIFIED_WEBHOOKS: 'true'

      - name: Run k6 API load test
        id: k6-api
        run: |
          BASE_URL="${{ github.event.inputs.base_url || 'http://localhost:3000' }}"
          SCENARIO="${{ matrix.scenario }}"

          echo "Running $SCENARIO test against $BASE_URL"

          k6 run \
            --env BASE_URL="$BASE_URL" \
            --env SCENARIO="$SCENARIO" \
            --env ENVIRONMENT="${{ github.event_name == 'pull_request' && 'pr' || 'ci' }}" \
            --env K6_VERSION="${{ env.K6_VERSION }}" \
            --out json=k6-api-results.json \
            scripts/k6/load-test.js 2>&1 | tee k6-api-output.txt

          # Check exit code
          K6_EXIT=${PIPESTATUS[0]}
          echo "k6_exit_code=$K6_EXIT" >> $GITHUB_OUTPUT

          # Extract summary if available
          if [ -f "summary.json" ]; then
            cp summary.json k6-api-summary.json
          fi

          exit $K6_EXIT
        continue-on-error: true

      - name: Generate API test summary
        if: always()
        run: |
          echo "## k6 API Load Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scenario:** ${{ matrix.scenario }}" >> $GITHUB_STEP_SUMMARY
          echo "**Base URL:** ${{ github.event.inputs.base_url || 'http://localhost:3000' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "k6-api-summary.json" ]; then
            # Parse JSON summary
            node -e "
              const summary = require('./k6-api-summary.json');
              console.log('### Metrics');
              console.log('');
              console.log('| Metric | Value |');
              console.log('|--------|-------|');
              console.log('| Total Requests | ' + (summary.metrics?.totalRequests || 'N/A') + ' |');
              console.log('| Success Rate | ' + (summary.metrics?.successRate?.toFixed(2) || 'N/A') + '% |');
              console.log('| Avg Duration | ' + (summary.metrics?.avgDuration?.toFixed(2) || 'N/A') + 'ms |');
              console.log('| p95 Duration | ' + (summary.metrics?.p95Duration?.toFixed(2) || 'N/A') + 'ms |');
              console.log('| p99 Duration | ' + (summary.metrics?.p99Duration?.toFixed(2) || 'N/A') + 'ms |');
            " >> $GITHUB_STEP_SUMMARY || true
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.k6-api.outputs.k6_exit_code }}" == "0" ]; then
            echo "**Status:** :white_check_mark: All thresholds passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** :x: Some thresholds failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload API test artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: k6-api-results-${{ matrix.scenario }}
          path: |
            k6-api-*.json
            k6-api-output.txt
            summary.json
            dashboard-payload.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Fail if thresholds not met
        if: steps.k6-api.outputs.k6_exit_code != '0'
        run: |
          echo "k6 test failed with exit code ${{ steps.k6-api.outputs.k6_exit_code }}"
          exit 1

  # =============================================================================
  # RLS Performance Tests
  # =============================================================================
  rls-load-test:
    name: RLS Load Test (${{ matrix.scenario }})
    runs-on: ubuntu-latest
    needs: [changes]
    if: |
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'rls')) ||
      github.event_name == 'schedule' ||
      (github.event_name != 'workflow_dispatch' && (needs.changes.outputs.api == 'true' || needs.changes.outputs.k6 == 'true'))
    strategy:
      fail-fast: false
      matrix:
        scenario:
          - ${{ github.event_name == 'pull_request' && 'smoke' || github.event.inputs.scenario || 'load' }}
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: medicalcor_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install k6
        run: |
          curl -fsSL https://github.com/grafana/k6/releases/download/v${{ env.K6_VERSION }}/k6-v${{ env.K6_VERSION }}-linux-amd64.tar.gz | tar -xz
          sudo mv k6-v${{ env.K6_VERSION }}-linux-amd64/k6 /usr/local/bin/
          k6 version

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build API
        run: pnpm --filter @medicalcor/api build
        env:
          NODE_ENV: production

      - name: Start API server
        run: |
          cd apps/api
          pnpm start &
          echo "Waiting for API to start..."
          timeout 60 bash -c 'until curl -s http://localhost:3000/health > /dev/null 2>&1; do sleep 1; done'
          echo "API is ready"
        env:
          NODE_ENV: production
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/medicalcor_test
          REDIS_URL: redis://localhost:6379
          API_SECRET_KEY: test-api-key
          ALLOW_UNVERIFIED_WEBHOOKS: 'true'
          RLS_TEST_MODE: 'true'

      - name: Run k6 RLS load test
        id: k6-rls
        run: |
          BASE_URL="${{ github.event.inputs.base_url || 'http://localhost:3000' }}"
          SCENARIO="${{ matrix.scenario }}"

          echo "Running RLS $SCENARIO test against $BASE_URL"

          k6 run \
            --env BASE_URL="$BASE_URL" \
            --env SCENARIO="$SCENARIO" \
            --env ENVIRONMENT="${{ github.event_name == 'pull_request' && 'pr' || 'ci' }}" \
            --env K6_VERSION="${{ env.K6_VERSION }}" \
            --env API_SECRET_KEY="test-api-key" \
            --out json=k6-rls-results.json \
            scripts/k6/rls-performance.js 2>&1 | tee k6-rls-output.txt

          K6_EXIT=${PIPESTATUS[0]}
          echo "k6_exit_code=$K6_EXIT" >> $GITHUB_OUTPUT

          if [ -f "rls-performance-summary.json" ]; then
            cp rls-performance-summary.json k6-rls-summary.json
          fi

          exit $K6_EXIT
        continue-on-error: true

      - name: Generate RLS test summary
        if: always()
        run: |
          echo "## k6 RLS Performance Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scenario:** ${{ matrix.scenario }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "k6-rls-summary.json" ]; then
            node -e "
              const summary = require('./k6-rls-summary.json');
              const rls = summary.rlsMetrics || {};
              const overhead = summary.overhead || {};
              const security = summary.security || {};

              console.log('### RLS Query Latency (p95)');
              console.log('');
              console.log('| Pattern | p95 (ms) |');
              console.log('|---------|----------|');
              console.log('| Clinic ID isolation | ' + (rls.clinicIdIsolation?.p95?.toFixed(2) || 'N/A') + ' |');
              console.log('| User ID isolation | ' + (rls.userIdIsolation?.p95?.toFixed(2) || 'N/A') + ' |');
              console.log('| Phone lookup | ' + (rls.phoneLookup?.p95?.toFixed(2) || 'N/A') + ' |');
              console.log('| Admin bypass | ' + (rls.adminBypass?.p95?.toFixed(2) || 'N/A') + ' |');
              console.log('| No RLS baseline | ' + (rls.noRlsBaseline?.p95?.toFixed(2) || 'N/A') + ' |');
              console.log('');
              console.log('### RLS Overhead');
              console.log('');
              console.log('| Metric | Value |');
              console.log('|--------|-------|');
              console.log('| Overhead | ' + (overhead.percentage?.toFixed(2) || 'N/A') + '% |');
              console.log('| Acceptable (<50%) | ' + (overhead.acceptable ? ':white_check_mark:' : ':x:') + ' |');
              console.log('');
              console.log('### Security');
              console.log('');
              console.log('| Check | Status |');
              console.log('|-------|--------|');
              console.log('| RLS Violations | ' + (security.rlsViolations || 0) + ' |');
              console.log('| Tenant Isolation | ' + (security.crossTenantIsolationVerified ? ':white_check_mark: Verified' : ':x: Failed') + ' |');
            " >> $GITHUB_STEP_SUMMARY || true
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.k6-rls.outputs.k6_exit_code }}" == "0" ]; then
            echo "**Status:** :white_check_mark: All thresholds passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** :x: Some thresholds failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload RLS test artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: k6-rls-results-${{ matrix.scenario }}
          path: |
            k6-rls-*.json
            k6-rls-output.txt
            rls-performance-summary.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Fail if thresholds not met
        if: steps.k6-rls.outputs.k6_exit_code != '0'
        run: |
          echo "k6 RLS test failed with exit code ${{ steps.k6-rls.outputs.k6_exit_code }}"
          exit 1

  # =============================================================================
  # PR Comment with Results
  # =============================================================================
  pr-comment:
    name: Post PR Comment
    runs-on: ubuntu-latest
    needs: [api-load-test, rls-load-test]
    if: github.event_name == 'pull_request' && always()
    steps:
      - name: Download API artifacts
        uses: actions/download-artifact@65a9edc5881444af0b9093a5e628f2fe47ea3b2e # v4.1.7
        with:
          pattern: k6-*-results-*
          path: artifacts
          merge-multiple: true
        continue-on-error: true

      - name: Generate PR comment
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            let apiSummary = null;
            let rlsSummary = null;

            // Try to read summaries
            try {
              if (fs.existsSync('artifacts/k6-api-summary.json')) {
                apiSummary = JSON.parse(fs.readFileSync('artifacts/k6-api-summary.json', 'utf8'));
              } else if (fs.existsSync('artifacts/summary.json')) {
                apiSummary = JSON.parse(fs.readFileSync('artifacts/summary.json', 'utf8'));
              }
            } catch (e) {
              console.log('Could not read API summary:', e.message);
            }

            try {
              if (fs.existsSync('artifacts/k6-rls-summary.json')) {
                rlsSummary = JSON.parse(fs.readFileSync('artifacts/k6-rls-summary.json', 'utf8'));
              } else if (fs.existsSync('artifacts/rls-performance-summary.json')) {
                rlsSummary = JSON.parse(fs.readFileSync('artifacts/rls-performance-summary.json', 'utf8'));
              }
            } catch (e) {
              console.log('Could not read RLS summary:', e.message);
            }

            const apiStatus = '${{ needs.api-load-test.result }}';
            const rlsStatus = '${{ needs.rls-load-test.result }}';

            const getStatusEmoji = (status) => {
              if (status === 'success') return ':white_check_mark:';
              if (status === 'failure') return ':x:';
              if (status === 'skipped') return ':fast_forward:';
              return ':grey_question:';
            };

            let body = `## k6 Load Test Results

            | Test Suite | Status |
            |------------|--------|
            | API Load Test | ${getStatusEmoji(apiStatus)} ${apiStatus} |
            | RLS Performance Test | ${getStatusEmoji(rlsStatus)} ${rlsStatus} |

            `;

            if (apiSummary) {
              const m = apiSummary.metrics || {};
              body += `
            ### API Metrics

            | Metric | Value |
            |--------|-------|
            | Total Requests | ${m.totalRequests || 'N/A'} |
            | Success Rate | ${m.successRate?.toFixed(2) || 'N/A'}% |
            | p95 Duration | ${m.p95Duration?.toFixed(2) || 'N/A'}ms |

            `;
            }

            if (rlsSummary) {
              const rls = rlsSummary.rlsMetrics || {};
              const overhead = rlsSummary.overhead || {};
              const security = rlsSummary.security || {};

              body += `
            ### RLS Performance

            | Pattern | p95 (ms) |
            |---------|----------|
            | Clinic ID | ${rls.clinicIdIsolation?.p95?.toFixed(2) || 'N/A'} |
            | User ID | ${rls.userIdIsolation?.p95?.toFixed(2) || 'N/A'} |
            | Phone | ${rls.phoneLookup?.p95?.toFixed(2) || 'N/A'} |

            **RLS Overhead:** ${overhead.percentage?.toFixed(2) || 'N/A'}% ${overhead.acceptable ? ':white_check_mark:' : ':x:'}
            **RLS Violations:** ${security.rlsViolations || 0} ${security.crossTenantIsolationVerified ? ':white_check_mark:' : ':x:'}

            `;
            }

            body += `
            <details>
            <summary>View full results in workflow artifacts</summary>

            Download the artifacts from the workflow run for detailed JSON reports.
            </details>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('k6 Load Test Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

  # =============================================================================
  # k6 Load Tests Success Gate
  # =============================================================================
  k6-success:
    name: k6 Load Tests
    runs-on: ubuntu-latest
    needs: [api-load-test, rls-load-test]
    if: always()
    steps:
      - name: Check all k6 jobs
        run: |
          echo "## k6 Load Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| API Load Test | ${{ needs.api-load-test.result == 'success' && '✅' || (needs.api-load-test.result == 'skipped' && '⏭️' || '❌') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| RLS Performance Test | ${{ needs.rls-load-test.result == 'success' && '✅' || (needs.rls-load-test.result == 'skipped' && '⏭️' || '❌') }} |" >> $GITHUB_STEP_SUMMARY

          # On PRs, smoke tests are required to pass
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ needs.api-load-test.result }}" == "failure" ]] || \
               [[ "${{ needs.rls-load-test.result }}" == "failure" ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**❌ k6 load tests failed - performance regression detected**" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi

          # On main branch, warn but don't fail (to not block deployments)
          if [[ "${{ needs.api-load-test.result }}" == "failure" ]] || \
             [[ "${{ needs.rls-load-test.result }}" == "failure" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**⚠️ k6 load tests failed - review recommended**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**✅ k6 load tests passed!**" >> $GITHUB_STEP_SUMMARY
          fi
