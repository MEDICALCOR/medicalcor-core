# OSS Security Checks - Lightweight security scanning workflow
# This workflow runs independently of the main CI pipeline for quick security feedback

name: OSS Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10.24.0'

permissions:
  contents: read

jobs:
  # =============================================================================
  # Build and Test Gate
  # =============================================================================
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run lint
        run: pnpm lint

      - name: Run unit tests
        run: pnpm test 2>&1 | tee test-output.log || true

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: unit-test-logs
          path: |
            test-output.log
            coverage/
          retention-days: 7

  # =============================================================================
  # pnpm Audit (Vulnerability Scan)
  # =============================================================================
  pnpm-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        id: audit
        run: |
          pnpm audit --json > pnpm-audit.json 2>&1 || true

          # Parse vulnerability counts
          CRITICAL=$(node -e "try { const r=require('./pnpm-audit.json'); console.log(r.metadata?.vulnerabilities?.critical || 0); } catch { console.log(0); }")
          HIGH=$(node -e "try { const r=require('./pnpm-audit.json'); console.log(r.metadata?.vulnerabilities?.high || 0); } catch { console.log(0); }")
          MODERATE=$(node -e "try { const r=require('./pnpm-audit.json'); console.log(r.metadata?.vulnerabilities?.moderate || 0); } catch { console.log(0); }")
          LOW=$(node -e "try { const r=require('./pnpm-audit.json'); console.log(r.metadata?.vulnerabilities?.low || 0); } catch { console.log(0); }")

          echo "## Dependency Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
          echo "| Low | $LOW |" >> $GITHUB_STEP_SUMMARY

          if [ "$CRITICAL" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Warning:** Critical vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: pnpm-audit
          path: pnpm-audit.json
          retention-days: 30

  # =============================================================================
  # Gitleaks Secret Scan
  # =============================================================================
  gitleaks-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install gitleaks
        run: |
          GITLEAKS_VERSION="8.21.2"
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" | tar -xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run gitleaks scan
        run: |
          gitleaks detect --source . --config .gitleaks.toml --report-format json --report-path gitleaks-report.json --verbose --redact 2>&1 | tee gitleaks-output.txt || {
            EXIT_CODE=$?
            echo "## Secret Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ $EXIT_CODE -eq 1 ]; then
              echo "**Potential secrets detected!** Review the gitleaks report." >> $GITHUB_STEP_SUMMARY
            fi
            # Don't fail the workflow, just report
            true
          }
          echo "## Secret Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**No secrets detected**" >> $GITHUB_STEP_SUMMARY

      - name: Upload gitleaks report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: gitleaks-report
          path: |
            gitleaks-report.json
            gitleaks-output.txt
          retention-days: 30

  # =============================================================================
  # OSSF Scorecard
  # =============================================================================
  ossf-scorecard:
    name: OpenSSF Scorecard
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      security-events: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: false

      - name: Run OSSF Scorecard
        uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a # v2.4.3
        with:
          results_file: scorecard-results.sarif
          results_format: sarif
          publish_results: true

      - name: Upload Scorecard results to Security tab
        uses: github/codeql-action/upload-sarif@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # v4.31.7
        with:
          sarif_file: scorecard-results.sarif

      - name: Upload Scorecard artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ossf-scorecard
          path: scorecard-results.sarif
          retention-days: 30

  # =============================================================================
  # Dependency Review (PRs only)
  # =============================================================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [build-and-test, pnpm-audit]
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.6.0
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0
          comment-summary-in-pr: always

  # =============================================================================
  # OSS Security Gate
  # =============================================================================
  oss-security-gate:
    name: OSS Security Gate
    runs-on: ubuntu-latest
    needs: [build-and-test, pnpm-audit, gitleaks-scan]
    if: always()
    steps:
      - name: Check security scan results
        run: |
          echo "## OSS Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Test | ${{ needs.build-and-test.result == 'success' && 'Pass' || 'Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.pnpm-audit.result == 'success' && 'Pass' || 'Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Detection | ${{ needs.gitleaks-scan.result == 'success' && 'Pass' || 'Fail' }} |" >> $GITHUB_STEP_SUMMARY

          # Fail if critical security checks failed
          if [[ "${{ needs.build-and-test.result }}" == "failure" ]] || \
             [[ "${{ needs.gitleaks-scan.result }}" == "failure" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Security gate failed - review the findings above.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**All OSS security checks passed.**" >> $GITHUB_STEP_SUMMARY
