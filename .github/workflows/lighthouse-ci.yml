# Lighthouse CI workflow for performance budgets and Core Web Vitals tracking
#
# Runs on PRs and main branch pushes to track performance regressions
# Reports Core Web Vitals: LCP, FID/TBT, CLS

name: Lighthouse CI

on:
  push:
    branches: [main]
    paths:
      - 'apps/web/**'
      - 'packages/**'
  pull_request:
    branches: [main]
    paths:
      - 'apps/web/**'
      - 'packages/**'

concurrency:
  group: lighthouse-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10.24.0'

permissions:
  contents: read
  pull-requests: write

jobs:
  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web app
        run: pnpm --filter @medicalcor/web build
        env:
          # Use mock values for build
          NEXT_PUBLIC_API_URL: http://localhost:3000
          NEXTAUTH_SECRET: test-secret-for-ci-build
          NEXTAUTH_URL: http://localhost:3001

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.13.x

      - name: Run Lighthouse CI
        run: |
          cd apps/web
          lhci autorun --config=./lighthouserc.js || true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: lighthouse-report
          path: apps/web/.lighthouseci/
          retention-days: 14

      - name: Generate summary
        if: always()
        run: |
          echo "## Lighthouse CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f apps/web/.lighthouseci/manifest.json ]; then
            echo "### Performance Scores" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Parse and display scores from manifest
            node -e "
              const fs = require('fs');
              const manifest = JSON.parse(fs.readFileSync('apps/web/.lighthouseci/manifest.json', 'utf8'));

              manifest.forEach((run, i) => {
                const summary = run.summary || {};
                console.log('| Metric | Score |');
                console.log('|--------|-------|');
                console.log('| Performance | ' + (summary.performance ? Math.round(summary.performance * 100) + '%' : 'N/A') + ' |');
                console.log('| Accessibility | ' + (summary.accessibility ? Math.round(summary.accessibility * 100) + '%' : 'N/A') + ' |');
                console.log('| Best Practices | ' + (summary['best-practices'] ? Math.round(summary['best-practices'] * 100) + '%' : 'N/A') + ' |');
                console.log('| SEO | ' + (summary.seo ? Math.round(summary.seo * 100) + '%' : 'N/A') + ' |');
                console.log('');
              });
            " >> $GITHUB_STEP_SUMMARY || echo "Unable to parse Lighthouse results" >> $GITHUB_STEP_SUMMARY

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Core Web Vitals Thresholds" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Target | Description |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
            echo "| LCP | < 2.5s | Largest Contentful Paint |" >> $GITHUB_STEP_SUMMARY
            echo "| FID/TBT | < 300ms | First Input Delay / Total Blocking Time |" >> $GITHUB_STEP_SUMMARY
            echo "| CLS | < 0.1 | Cumulative Layout Shift |" >> $GITHUB_STEP_SUMMARY
          else
            echo "No Lighthouse results found" >> $GITHUB_STEP_SUMMARY
          fi

  # Performance regression check
  performance-budget-check:
    name: Performance Budget Check
    runs-on: ubuntu-latest
    needs: lighthouse
    if: github.event_name == 'pull_request'
    steps:
      - name: Download Lighthouse report
        uses: actions/download-artifact@18f0f591fbc635562c815484d73b6e8e3c8d9566 # v4.2.1
        with:
          name: lighthouse-report
          path: lighthouse-report/

      - name: Check performance budgets
        run: |
          if [ -f lighthouse-report/assertion-results.json ]; then
            FAILURES=$(node -e "
              const results = require('./lighthouse-report/assertion-results.json');
              const failures = results.filter(r => r.level === 'error' && !r.passed);
              console.log(failures.length);
            ")

            if [ "$FAILURES" -gt 0 ]; then
              echo "## Performance Budget Violations" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Found $FAILURES performance budget violations that need attention." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Please review the Lighthouse report artifact for details." >> $GITHUB_STEP_SUMMARY

              # Don't fail the build, just warn
              echo "::warning::Found $FAILURES performance budget violations"
            else
              echo "## Performance Budgets" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**All performance budgets passed.**" >> $GITHUB_STEP_SUMMARY
            fi
          fi
