name: Bulk Create Issues

on:
  workflow_dispatch:
    inputs:
      backlog_file:
        description: "Path to backlog YAML in repo"
        required: true
        default: "BACKLOG.yml"
      dry_run:
        description: "If true, only prints what would be created"
        required: false
        default: "false"

permissions:
  contents: read
  issues: write

jobs:
  create_issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Create issues from backlog YAML (idempotent)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BACKLOG_FILE: ${{ github.event.inputs.backlog_file }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          python <<'PY'
          import os, json, time
          import yaml, requests

          token = os.environ["GITHUB_TOKEN"]
          repo = os.environ["REPO"]
          backlog_file = os.environ["BACKLOG_FILE"]
          dry_run = os.environ.get("DRY_RUN", "false").lower() == "true"

          owner, name = repo.split("/")
          api_base = "https://api.github.com"
          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json",
              "X-GitHub-Api-Version": "2022-11-28",
          }

          def gh_get(path, params=None):
              r = requests.get(f"{api_base}{path}", headers=headers, params=params)
              r.raise_for_status()
              return r.json()

          def gh_post(path, payload):
              r = requests.post(f"{api_base}{path}", headers=headers, json=payload)
              r.raise_for_status()
              return r.json()

          # 1) Load backlog YAML
          with open(backlog_file, "r", encoding="utf-8") as f:
              docs = list(yaml.safe_load_all(f))

          # Merge issues from all YAML documents
          issues = []
          for d in docs:
              if isinstance(d, dict) and d.get("issues"):
                  issues.extend(d["issues"])

          if not issues:
              print("No issues found in backlog.")
              raise SystemExit(0)

          # 2) Build milestone title -> number map
          milestones = gh_get(f"/repos/{owner}/{name}/milestones", params={"state": "all", "per_page": 100})
          milestone_map = {m["title"]: m["number"] for m in milestones}

          # 3) Helper: check if issue exists by exact title
          def issue_exists(title):
              q = f'repo:{owner}/{name} is:issue in:title "{title}"'
              res = gh_get("/search/issues", params={"q": q, "per_page": 5})
              for item in res.get("items", []):
                  if item.get("title") == title:
                      return item["number"]
              return None

          created = 0
          skipped = 0

          for i, item in enumerate(issues, start=1):
              title = item["title"].strip()
              body = item.get("body", "").strip()
              labels = item.get("labels", []) or []
              milestone_title = item.get("milestone")
              milestone_number = milestone_map.get(milestone_title) if milestone_title else None

              existing = issue_exists(title)
              if existing:
                  skipped += 1
                  print(f"[{i}] SKIP (exists #{existing}): {title}")
                  continue

              payload = {
                  "title": title,
                  "body": body,
              }
              if labels:
                  payload["labels"] = labels
              if milestone_number:
                  payload["milestone"] = milestone_number

              if dry_run:
                  print(f"[{i}] DRY RUN create: {json.dumps(payload, ensure_ascii=False)}")
              else:
                  out = gh_post(f"/repos/{owner}/{name}/issues", payload)
                  created += 1
                  print(f"[{i}] CREATED #{out['number']}: {title}")

              time.sleep(0.25)  # small throttle

          print("\n=== SUMMARY ===")
          print(f"Created: {created}")
          print(f"Skipped (already existed): {skipped}")
          print(f"Dry run: {dry_run}")
          PY
