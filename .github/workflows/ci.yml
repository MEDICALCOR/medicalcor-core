# This workflow uses the default GITHUB_TOKEN with minimal permissions (contents: read)
# to ensure reliable repository checkout. The token is explicitly passed to checkout steps
# to prevent authentication failures. If checking out external private repositories is needed,
# create a PAT with repo scope and add it to repository secrets.

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  merge_group:
    types: [checks_requested]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9.14.2'
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

# Minimal permissions following principle of least privilege
permissions:
  contents: read

jobs:
  # =============================================================================
  # Changes Detection - Skip unnecessary jobs
  # =============================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      src: ${{ steps.filter.outputs.src }}
      docs: ${{ steps.filter.outputs.docs }}
      docker: ${{ steps.filter.outputs.docker }}
      deps: ${{ steps.filter.outputs.deps }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Filter paths
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            src:
              - 'apps/**'
              - 'packages/**'
              - 'pnpm-lock.yaml'
              - 'tsconfig*.json'
            docs:
              - 'docs/**'
              - '*.md'
            docker:
              - 'apps/api/Dockerfile'
              - 'docker-compose*.yml'
            deps:
              - 'package.json'
              - 'pnpm-lock.yaml'
              - '**/package.json'

  # =============================================================================
  # Dependency Review (PRs only) - Block vulnerable dependencies
  # =============================================================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Dependency Review
        uses: actions/dependency-review-action@da24556b548a50705dd671f47852072ea4c105d9 # v4.6.0
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0
          comment-summary-in-pr: always

  # =============================================================================
  # Lint & Format Check
  # =============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.src == 'true' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint

      - name: Check formatting
        run: pnpm format:check

  # =============================================================================
  # Code Duplication Check
  # =============================================================================
  duplication:
    name: Code Duplication
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.src == 'true' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check code duplication
        id: jscpd
        run: |
          pnpm check:duplication || true

          if [ -f .jscpd-report/jscpd-report.json ]; then
            TOTAL_LINES=$(node -e "const r=require('./.jscpd-report/jscpd-report.json'); console.log(r.statistics?.total?.lines || 0);")
            DUP_LINES=$(node -e "const r=require('./.jscpd-report/jscpd-report.json'); console.log(r.statistics?.total?.duplicatedLines || 0);")
            PERCENTAGE=$(node -e "const r=require('./.jscpd-report/jscpd-report.json'); console.log((r.statistics?.total?.percentage || 0).toFixed(2));")

            echo "## Code Duplication Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Lines Analyzed | $TOTAL_LINES |" >> $GITHUB_STEP_SUMMARY
            echo "| Duplicated Lines | $DUP_LINES |" >> $GITHUB_STEP_SUMMARY
            echo "| Duplication Percentage | $PERCENTAGE% |" >> $GITHUB_STEP_SUMMARY

            # Fail if duplication exceeds 10%
            THRESHOLD=10
            if (( $(echo "$PERCENTAGE > $THRESHOLD" | bc -l) )); then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Warning:** Duplication exceeds ${THRESHOLD}% threshold" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        continue-on-error: true

      - name: Upload duplication report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: duplication-report
          path: .jscpd-report/
          retention-days: 30

  # =============================================================================
  # Type Check
  # =============================================================================
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.src == 'true' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript type check
        run: pnpm typecheck

  # =============================================================================
  # Unit Tests
  # =============================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.src == 'true' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm test:coverage

      - name: Upload coverage
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # =============================================================================
  # E2E Tests (Sharded for speed)
  # =============================================================================
  e2e:
    name: E2E Tests (${{ matrix.shard }}/${{ matrix.total-shards }})
    runs-on: ubuntu-latest
    needs: [changes, test]
    if: needs.changes.outputs.src == 'true' || github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2]
        total-shards: [2]
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache Playwright browsers
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd apps/api && pnpm exec playwright install --with-deps chromium

      - name: Install Playwright deps (cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: cd apps/api && pnpm exec playwright install-deps chromium

      - name: Run E2E tests (shard ${{ matrix.shard }})
        run: cd apps/api && pnpm test:e2e --shard=${{ matrix.shard }}/${{ matrix.total-shards }}
        env:
          NODE_ENV: test
          API_URL: http://localhost:3000
          WHATSAPP_WEBHOOK_SECRET: test-secret
          TWILIO_WEBHOOK_SECRET: test-secret
          STRIPE_WEBHOOK_SECRET: test-secret
          API_KEY: test-api-key
          ALLOW_UNVERIFIED_WEBHOOKS: 'true'
          CI: 'true'

      - name: Upload Playwright report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: playwright-report-${{ matrix.shard }}
          path: apps/api/playwright-report/
          retention-days: 7

  # =============================================================================
  # Build
  # =============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, e2e]
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: build-artifacts
          path: |
            packages/*/dist
            apps/*/dist
          retention-days: 7

  # =============================================================================
  # Docker Build with Multi-arch & Attestations
  # =============================================================================
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Build Docker image
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: apps/api/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: false
          tags: medicalcor-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      - name: Generate SBOM
        uses: anchore/sbom-action@fbfd9c6c189226748411491745178e0c2017392d # v0.20.10
        with:
          image: medicalcor-api:${{ github.sha }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: sbom
          path: sbom.spdx.json
          retention-days: 90

  # =============================================================================
  # Security Scan
  # =============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.src == 'true' || needs.changes.outputs.deps == 'true' || github.ref == 'refs/heads/main'
    permissions:
      contents: read
      actions: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        id: audit
        run: |
          echo "Running pnpm audit..."
          pnpm audit --json > audit-results.json || true

          CRITICAL=$(node -e "try { const r=require('./audit-results.json'); console.log(r.metadata?.vulnerabilities?.critical || 0); } catch { console.log(0); }")
          HIGH=$(node -e "try { const r=require('./audit-results.json'); console.log(r.metadata?.vulnerabilities?.high || 0); } catch { console.log(0); }")

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT

          echo "## Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "Found $CRITICAL critical and $HIGH high severity vulnerabilities"
            exit 1
          fi
        continue-on-error: true

      - name: Upload audit results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: security-audit-results
          path: audit-results.json
          retention-days: 30

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@fe4161a26a8629af62121b670040955b330f9af2 # v4.31.6
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # =============================================================================
  # Secrets Scanning
  # =============================================================================
  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install gitleaks
        run: |
          GITLEAKS_VERSION="8.21.2"
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" | tar -xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run gitleaks scan
        run: |
          # Scan for secrets in the repository using project config
          gitleaks detect --source . --config .gitleaks.toml --verbose --redact --exit-code 1 2>&1 | tee gitleaks-report.txt || {
            EXIT_CODE=$?
            echo "## Secrets Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ $EXIT_CODE -eq 1 ]; then
              echo "**⚠️ Potential secrets found!** Review the gitleaks report." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              tail -100 gitleaks-report.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
            exit $EXIT_CODE
          }
          echo "## Secrets Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**✅ No secrets detected**" >> $GITHUB_STEP_SUMMARY

      - name: Upload gitleaks report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        if: always()
        with:
          name: gitleaks-report
          path: gitleaks-report.txt
          retention-days: 30

  # =============================================================================
  # License Compliance Check
  # =============================================================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.deps == 'true' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check licenses
        run: |
          npx license-checker --summary --production --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;CC0-1.0;Unlicense;CC-BY-4.0;CC-BY-3.0;Python-2.0;BlueOak-1.0.0" || {
            echo "## License Check Failed" >> $GITHUB_STEP_SUMMARY
            echo "Found packages with non-approved licenses" >> $GITHUB_STEP_SUMMARY
            exit 1
          }

  # =============================================================================
  # OpenSSF Scorecard
  # =============================================================================
  scorecard:
    name: OpenSSF Scorecard
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      security-events: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: false

      - name: Run Scorecard
        uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a # v2.4.3
        with:
          results_file: scorecard-results.sarif
          results_format: sarif
          publish_results: true

      - name: Upload Scorecard results
        uses: github/codeql-action/upload-sarif@fe4161a26a8629af62121b670040955b330f9af2 # v4.31.6
        with:
          sarif_file: scorecard-results.sarif

  # =============================================================================
  # Database Schema Validation
  # =============================================================================
  schema-validation:
    name: Schema Validation
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.src == 'true' || github.ref == 'refs/heads/main'
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: medicalcor_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dbmate
        run: |
          curl -fsSL -o /usr/local/bin/dbmate https://github.com/amacneil/dbmate/releases/download/v2.10.0/dbmate-linux-amd64
          chmod +x /usr/local/bin/dbmate

      - name: Validate migration files
        run: |
          chmod +x ./scripts/validate-schema.sh
          ./scripts/validate-schema.sh

      - name: Run migrations (up)
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/medicalcor_test?sslmode=disable
        run: |
          cd db
          dbmate --migrations-dir ./migrations up

      - name: Verify migrations are reversible (down + up)
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/medicalcor_test?sslmode=disable
        run: |
          cd db
          dbmate --migrations-dir ./migrations down
          dbmate --migrations-dir ./migrations up

      - name: Dump final schema
        env:
          PGPASSWORD: postgres
        run: |
          pg_dump -h localhost -U postgres -d medicalcor_test --schema-only > db/schema.sql

      - name: Upload schema artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: database-schema
          path: db/schema.sql
          retention-days: 30

  # =============================================================================
  # CI Success Gate
  # =============================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      [lint, typecheck, test, e2e, build, security, secrets-scan, schema-validation, license-check]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "## CI Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && '✅' || (needs.lint.result == 'skipped' && '⏭️' || '❌') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | ${{ needs.typecheck.result == 'success' && '✅' || (needs.typecheck.result == 'skipped' && '⏭️' || '❌') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && '✅' || (needs.test.result == 'skipped' && '⏭️' || '❌') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e.result == 'success' && '✅' || (needs.e2e.result == 'skipped' && '⏭️' || '❌') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '✅' || (needs.build.result == 'skipped' && '⏭️' || '❌') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && '✅' || (needs.security.result == 'skipped' && '⏭️' || '⚠️') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets Scan | ${{ needs.secrets-scan.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Schema Validation | ${{ needs.schema-validation.result == 'success' && '✅' || (needs.schema-validation.result == 'skipped' && '⏭️' || '❌') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result == 'success' && '✅' || (needs.license-check.result == 'skipped' && '⏭️' || '⚠️') }} |" >> $GITHUB_STEP_SUMMARY

          # Check required jobs (failures block merge)
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.typecheck.result }}" == "failure" ]] || \
             [[ "${{ needs.test.result }}" == "failure" ]] || \
             [[ "${{ needs.e2e.result }}" == "failure" ]] || \
             [[ "${{ needs.build.result }}" == "failure" ]] || \
             [[ "${{ needs.secrets-scan.result }}" == "failure" ]] || \
             [[ "${{ needs.schema-validation.result }}" == "failure" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**❌ One or more required checks failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**✅ All required checks passed!**" >> $GITHUB_STEP_SUMMARY
