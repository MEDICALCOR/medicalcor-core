# KEDA ScaledObjects - Event-Driven Auto-Scaling
#
# Event-driven autoscaling for MedicalCor OSAX platform.
# Scales based on HTTP requests, queue depth, and business metrics.
#
# PERFORMANCE: Enables rapid scale-up during traffic spikes.
# COST: Enables scale-to-zero for non-critical workloads.

apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: osax-api-scaler
  namespace: osax
  labels:
    app.kubernetes.io/name: osax
    app.kubernetes.io/component: api
    app.kubernetes.io/managed-by: keda
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: osax-api

  # Scaling behavior
  pollingInterval: 15
  cooldownPeriod: 300
  minReplicaCount: 3
  maxReplicaCount: 20
  fallback:
    failureThreshold: 3
    replicas: 5

  # Advanced scaling configuration
  advanced:
    restoreToOriginalReplicaCount: false
    horizontalPodAutoscalerConfig:
      name: osax-api-keda-hpa
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 300
          policies:
            - type: Percent
              value: 10
              periodSeconds: 60
            - type: Pods
              value: 1
              periodSeconds: 60
          selectPolicy: Min
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
            - type: Percent
              value: 100
              periodSeconds: 15
            - type: Pods
              value: 4
              periodSeconds: 15
          selectPolicy: Max

  triggers:
    # HTTP Request Rate (RPS-based scaling)
    - type: prometheus
      metadata:
        serverAddress: http://prometheus.monitoring.svc.cluster.local:9090
        metricName: http_requests_per_second
        query: |
          sum(rate(http_requests_total{namespace="osax",service="osax-api"}[2m]))
        threshold: '100'
        activationThreshold: '50'

    # CPU Utilization (fallback)
    - type: cpu
      metricType: Utilization
      metadata:
        value: '70'

    # Memory Utilization
    - type: memory
      metricType: Utilization
      metadata:
        value: '80'

    # Concurrent Connections
    - type: prometheus
      metadata:
        serverAddress: http://prometheus.monitoring.svc.cluster.local:9090
        metricName: active_connections
        query: |
          sum(osax_active_connections{namespace="osax"})
        threshold: '500'

---
# KEDA ScaledObject - Worker/Background Jobs
#
# Scales worker pods based on Redis queue depth.

apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: osax-worker-scaler
  namespace: osax
  labels:
    app.kubernetes.io/name: osax
    app.kubernetes.io/component: worker
    app.kubernetes.io/managed-by: keda
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: osax-worker

  pollingInterval: 10
  cooldownPeriod: 180
  minReplicaCount: 1
  maxReplicaCount: 10
  fallback:
    failureThreshold: 3
    replicas: 2

  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 180
          policies:
            - type: Percent
              value: 25
              periodSeconds: 60
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
            - type: Pods
              value: 2
              periodSeconds: 30

  triggers:
    # Redis Queue Length (Trigger.dev jobs)
    - type: redis
      metadata:
        address: redis.osax.svc.cluster.local:6379
        listName: trigger:jobs:pending
        listLength: '5'
        activationListLength: '1'
        enableTLS: 'true'
      authenticationRef:
        name: osax-redis-auth

    # Pending AI Processing Tasks
    - type: prometheus
      metadata:
        serverAddress: http://prometheus.monitoring.svc.cluster.local:9090
        metricName: pending_ai_tasks
        query: |
          sum(osax_ai_tasks_pending{namespace="osax"})
        threshold: '10'
        activationThreshold: '5'

    # Case Processing Queue
    - type: prometheus
      metadata:
        serverAddress: http://prometheus.monitoring.svc.cluster.local:9090
        metricName: pending_cases
        query: |
          sum(osax_cases_pending_processing{namespace="osax"})
        threshold: '20'

---
# KEDA ScaledObject - AI Embedding Service
#
# Scales embedding generation pods based on pending embeddings.

apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: osax-embedding-scaler
  namespace: osax
  labels:
    app.kubernetes.io/name: osax
    app.kubernetes.io/component: embedding
    app.kubernetes.io/managed-by: keda
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: osax-embedding-worker

  pollingInterval: 15
  cooldownPeriod: 300
  minReplicaCount: 0 # Scale to zero when idle
  maxReplicaCount: 5
  idleReplicaCount: 0 # Enable scale-to-zero

  triggers:
    # Pending Embedding Jobs
    - type: prometheus
      metadata:
        serverAddress: http://prometheus.monitoring.svc.cluster.local:9090
        metricName: pending_embeddings
        query: |
          sum(osax_embeddings_pending{namespace="osax"})
        threshold: '10'
        activationThreshold: '1'

    # Vector Index Update Queue
    - type: redis
      metadata:
        address: redis.osax.svc.cluster.local:6379
        listName: embeddings:pending
        listLength: '5'
        activationListLength: '1'
      authenticationRef:
        name: osax-redis-auth

---
# KEDA TriggerAuthentication - Redis Credentials
#
# Secure authentication for Redis-based scaling triggers.

apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: osax-redis-auth
  namespace: osax
spec:
  secretTargetRef:
    - parameter: password
      name: osax-redis-secret
      key: redis-password

---
# KEDA ScaledObject - Cron-based Scaling
#
# Scheduled scaling for predictable traffic patterns.

apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: osax-scheduled-scaler
  namespace: osax
  labels:
    app.kubernetes.io/name: osax
    app.kubernetes.io/component: api
    app.kubernetes.io/managed-by: keda
    scaling-type: scheduled
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: osax-api

  pollingInterval: 60
  cooldownPeriod: 60
  minReplicaCount: 3
  maxReplicaCount: 20

  triggers:
    # Business Hours (Mon-Fri 8:00-18:00 Europe/Bucharest)
    - type: cron
      metadata:
        timezone: Europe/Bucharest
        start: 0 8 * * 1-5
        end: 0 18 * * 1-5
        desiredReplicas: '8'

    # Peak Hours (Mon-Fri 10:00-12:00, 14:00-16:00)
    - type: cron
      metadata:
        timezone: Europe/Bucharest
        start: 0 10 * * 1-5
        end: 0 12 * * 1-5
        desiredReplicas: '12'

    - type: cron
      metadata:
        timezone: Europe/Bucharest
        start: 0 14 * * 1-5
        end: 0 16 * * 1-5
        desiredReplicas: '12'

    # Night/Weekend (minimal)
    - type: cron
      metadata:
        timezone: Europe/Bucharest
        start: 0 18 * * 1-5
        end: 0 8 * * 1-5
        desiredReplicas: '3'

    - type: cron
      metadata:
        timezone: Europe/Bucharest
        start: 0 0 * * 0,6
        end: 0 0 * * 1
        desiredReplicas: '3'
