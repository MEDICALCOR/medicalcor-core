# OSAX Helm Chart Values
#
# Default configuration for MedicalCor OSAX deployment.
# Override for specific environments using values-{env}.yaml files.
#
# HIPAA Compliance: Default settings enforce security requirements.

# ============================================================================
# GLOBAL SETTINGS
# ============================================================================

global:
  # Environment identifier
  environment: production

  # Cloud provider (aws, azure, gcp)
  cloudProvider: aws

  # Primary deployment region
  region: eu-central-1

  # Application domain
  domain: osax.medicalcor.ro

  # Image pull secrets
  imagePullSecrets: []

  # Node selector for all pods
  nodeSelector: {}

  # Tolerations for all pods
  tolerations: []

  # Affinity rules for all pods
  affinity: {}

# ============================================================================
# APPLICATION CONFIGURATION
# ============================================================================

app:
  name: osax

  # Replica count (HA in production)
  replicas: 3

  # Container image
  image:
    repository: medicalcor/osax
    tag: v3.0.0
    pullPolicy: IfNotPresent

  # Resource limits and requests
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "2000m"
      memory: "4Gi"

  # Environment variables
  env:
    - name: NODE_ENV
      value: "production"
    - name: STRICT_HIPAA_MODE
      value: "true"
    - name: DB_QUERY_TIMEOUT_MS
      value: "30000"
    - name: LOG_LEVEL
      value: "info"
    - name: LOG_FORMAT
      value: "json"
    - name: METRICS_ENABLED
      value: "true"
    - name: TRACING_ENABLED
      value: "true"

  # Port configuration
  ports:
    http: 3000
    metrics: 9090

  # Health check configuration
  healthCheck:
    liveness:
      path: /api/health
      port: 3000
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readiness:
      path: /api/health
      port: 3000
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3
    startup:
      path: /api/health
      port: 3000
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 30

  # Horizontal Pod Autoscaler
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

    # Scale-down stabilization
    behavior:
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
          - type: Percent
            value: 10
            periodSeconds: 60
      scaleUp:
        stabilizationWindowSeconds: 0
        policies:
          - type: Percent
            value: 100
            periodSeconds: 15
          - type: Pods
            value: 4
            periodSeconds: 15

  # Pod Disruption Budget
  pdb:
    enabled: true
    minAvailable: 2

  # Service account
  serviceAccount:
    create: true
    name: osax-sa
    annotations: {}

# ============================================================================
# DATABASE CONFIGURATION
# ============================================================================

database:
  # Connection is provided via Terraform output
  host: ""
  port: 5432
  name: medicalcor_osax
  sslMode: require

  # Connection pool settings
  pool:
    min: 5
    max: 20
    idleTimeoutMs: 30000
    connectionTimeoutMs: 5000

# ============================================================================
# SECRETS CONFIGURATION
# ============================================================================

secrets:
  # These should be provided via external secrets or sealed secrets
  databasePassword: ""
  encryptionKey: ""
  jwtSecret: ""
  openaiApiKey: ""

  # External secrets configuration
  externalSecrets:
    enabled: false
    secretStore: ""
    refreshInterval: "1h"

# ============================================================================
# MONITORING CONFIGURATION
# ============================================================================

monitoring:
  # Prometheus metrics
  prometheus:
    enabled: true
    port: 9090
    path: /metrics

    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 10s
      labels:
        release: prometheus

  # Grafana dashboards
  grafana:
    enabled: true
    dashboards:
      enabled: true
      labels:
        grafana_dashboard: "1"

  # Alerting
  alerts:
    enabled: true
    labels:
      team: platform

# ============================================================================
# SECURITY CONFIGURATION
# ============================================================================

security:
  # Pod Security Policy
  podSecurityPolicy:
    enabled: true
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    readOnlyRootFilesystem: true

    # Capabilities
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL

  # Network Policy
  networkPolicy:
    enabled: true

    # Ingress rules
    ingress:
      - from:
          - namespaceSelector:
              matchLabels:
                name: ingress-nginx
          - podSelector:
              matchLabels:
                app: ingress-nginx
        ports:
          - protocol: TCP
            port: 3000

    # Egress rules
    egress:
      # Allow DNS
      - to:
          - namespaceSelector: {}
        ports:
          - protocol: UDP
            port: 53
          - protocol: TCP
            port: 53
      # Allow database
      - to:
          - ipBlock:
              cidr: 10.0.0.0/8
        ports:
          - protocol: TCP
            port: 5432
      # Allow HTTPS (external APIs)
      - to:
          - ipBlock:
              cidr: 0.0.0.0/0
              except:
                - 10.0.0.0/8
                - 172.16.0.0/12
                - 192.168.0.0/16
        ports:
          - protocol: TCP
            port: 443

# ============================================================================
# INGRESS CONFIGURATION
# ============================================================================

ingress:
  enabled: true
  className: nginx

  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"

    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"

    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
      add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self' https:;" always;

  hosts:
    - host: osax.medicalcor.ro
      paths:
        - path: /
          pathType: Prefix

  tls:
    - secretName: osax-tls
      hosts:
        - osax.medicalcor.ro

# ============================================================================
# SERVICE CONFIGURATION
# ============================================================================

service:
  type: ClusterIP
  port: 80
  targetPort: 3000

  annotations: {}

# ============================================================================
# PERSISTENCE CONFIGURATION
# ============================================================================

persistence:
  # Temporary storage for processing
  temp:
    enabled: true
    size: 1Gi
    storageClass: ""
    accessMode: ReadWriteOnce

# ============================================================================
# ADDITIONAL COMPONENTS
# ============================================================================

# Redis for caching/sessions
redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: true
    password: ""
  master:
    persistence:
      enabled: true
      size: 1Gi

# Worker for background jobs
worker:
  enabled: true
  replicas: 2
  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "2Gi"
