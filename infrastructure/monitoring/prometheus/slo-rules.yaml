# OSAX SLO Alert Rules
#
# Service Level Objective alerts for MedicalCor OSAX platform.
# These rules implement error budget-based alerting for critical SLOs.
#
# HIPAA/GDPR Compliance: Encryption and data protection SLOs are marked as CRITICAL.

groups:
  - name: osax_slo_alerts
    interval: 30s
    rules:
      # ============================================================================
      # AVAILABILITY SLO (99.9% target)
      # ============================================================================

      - alert: SLOAvailabilityBudgetBurning
        expr: |
          (
            1 - (
              sum(rate(http_requests_total{status!~"5.."}[1h]))
              /
              sum(rate(http_requests_total[1h]))
            )
          ) > 0.001
        for: 5m
        labels:
          severity: warning
          slo: availability
          slo_target: '99.9%'
          team: platform
        annotations:
          summary: 'Availability SLO burning too fast'
          description: |
            Error rate {{ $value | humanizePercentage }} exceeds hourly error budget.
            Current availability: {{ printf "%.3f" (100 - ($value * 100)) }}%
            Target: 99.9%
          runbook_url: 'https://docs.medicalcor.ro/runbooks/availability-slo'
          dashboard_url: 'https://grafana.medicalcor.ro/d/osax-slo/availability'

      - alert: SLOAvailabilityCritical
        expr: |
          (
            1 - (
              sum(rate(http_requests_total{status!~"5.."}[5m]))
              /
              sum(rate(http_requests_total[5m]))
            )
          ) > 0.01
        for: 2m
        labels:
          severity: critical
          slo: availability
          slo_target: '99.9%'
          team: platform
          pagerduty: 'true'
        annotations:
          summary: 'CRITICAL: Availability SLO severely violated'
          description: |
            Error rate {{ $value | humanizePercentage }} is critically high.
            Immediate investigation required.
          runbook_url: 'https://docs.medicalcor.ro/runbooks/availability-critical'

      # ============================================================================
      # LATENCY SLO (P95 < 2s, P99 < 5s)
      # ============================================================================

      - alert: SLOLatencyP95Violated
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
          ) > 2
        for: 10m
        labels:
          severity: warning
          slo: latency_p95
          slo_target: '2s'
          team: platform
        annotations:
          summary: 'P95 latency SLO violated'
          description: |
            P95 latency is {{ $value | humanizeDuration }} (target: <2s).
            Performance degradation detected.
          runbook_url: 'https://docs.medicalcor.ro/runbooks/latency-p95'
          dashboard_url: 'https://grafana.medicalcor.ro/d/osax-slo/latency'

      - alert: SLOLatencyP99Violated
        expr: |
          histogram_quantile(0.99,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
          ) > 5
        for: 10m
        labels:
          severity: warning
          slo: latency_p99
          slo_target: '5s'
          team: platform
        annotations:
          summary: 'P99 latency SLO violated'
          description: |
            P99 latency is {{ $value | humanizeDuration }} (target: <5s).
            Tail latency is impacting user experience.
          runbook_url: 'https://docs.medicalcor.ro/runbooks/latency-p99'

      - alert: SLOLatencyCritical
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
          ) > 10
        for: 5m
        labels:
          severity: critical
          slo: latency
          team: platform
          pagerduty: 'true'
        annotations:
          summary: 'CRITICAL: Service severely degraded'
          description: |
            P95 latency is {{ $value | humanizeDuration }}.
            Service is experiencing severe performance issues.
          runbook_url: 'https://docs.medicalcor.ro/runbooks/latency-critical'

      # ============================================================================
      # ENCRYPTION SLO (99.999% success - HIPAA COMPLIANCE)
      # ============================================================================

      - alert: SLOEncryptionFailures
        expr: |
          (
            sum(rate(osax_encryption_total{status="failure"}[5m]))
            /
            sum(rate(osax_encryption_total[5m]))
          ) > 0.0001
        for: 5m
        labels:
          severity: critical
          slo: encryption_success
          slo_target: '99.999%'
          compliance: HIPAA
          team: security
          pagerduty: 'true'
        annotations:
          summary: 'CRITICAL: Encryption SLO violated - HIPAA risk'
          description: |
            Encryption failure rate: {{ $value | humanizePercentage }}
            This is a HIPAA compliance violation risk.
            Immediate security review required.
          runbook_url: 'https://docs.medicalcor.ro/runbooks/encryption-failure'

      - alert: SLODecryptionFailures
        expr: |
          (
            sum(rate(osax_decryption_total{status="failure"}[5m]))
            /
            sum(rate(osax_decryption_total[5m]))
          ) > 0.0001
        for: 5m
        labels:
          severity: critical
          slo: decryption_success
          slo_target: '99.999%'
          compliance: HIPAA
          team: security
          pagerduty: 'true'
        annotations:
          summary: 'CRITICAL: Decryption SLO violated - HIPAA risk'
          description: |
            Decryption failure rate: {{ $value | humanizePercentage }}
            PHI access may be impacted. Security review required.
          runbook_url: 'https://docs.medicalcor.ro/runbooks/decryption-failure'

      # ============================================================================
      # AUDIT LOGGING SLO (100% success - HIPAA/GDPR COMPLIANCE)
      # ============================================================================

      - alert: SLOAuditLoggingFailures
        expr: |
          sum(rate(osax_audit_log_failures_total[5m])) > 0
        for: 1m
        labels:
          severity: critical
          slo: audit_logging
          slo_target: '100%'
          compliance: 'HIPAA,GDPR'
          team: security
          pagerduty: 'true'
        annotations:
          summary: 'CRITICAL: Audit logging failures - Compliance risk'
          description: |
            Audit log write failures detected.
            HIPAA/GDPR compliance at risk - all PHI access MUST be logged.
          runbook_url: 'https://docs.medicalcor.ro/runbooks/audit-failure'

      # ============================================================================
      # DATABASE SLO
      # ============================================================================

      - alert: SLODatabaseConnectionExhausted
        expr: |
          (
            pg_stat_activity_count{state="active"}
            /
            pg_settings_max_connections
          ) > 0.8
        for: 5m
        labels:
          severity: warning
          slo: database_capacity
          team: platform
        annotations:
          summary: 'Database connection pool >80% utilized'
          description: |
            Connection utilization: {{ $value | humanizePercentage }}
            Consider scaling or optimizing queries.
          runbook_url: 'https://docs.medicalcor.ro/runbooks/database-connections'

      - alert: SLODatabaseReplicationLag
        expr: |
          pg_replication_lag_seconds > 30
        for: 5m
        labels:
          severity: warning
          slo: database_replication
          team: platform
        annotations:
          summary: 'Database replication lag >30s'
          description: |
            Replication lag: {{ $value | humanizeDuration }}
            Failover readiness may be impacted.
          runbook_url: 'https://docs.medicalcor.ro/runbooks/replication-lag'

      # ============================================================================
      # OSAX CASE PROCESSING SLO
      # ============================================================================

      - alert: SLOCaseCreationSlow
        expr: |
          histogram_quantile(0.95,
            sum(rate(osax_case_creation_duration_seconds_bucket[5m])) by (le)
          ) > 5
        for: 10m
        labels:
          severity: warning
          slo: case_creation_latency
          slo_target: '5s'
          team: backend
        annotations:
          summary: 'Case creation P95 latency >5s'
          description: |
            P95 case creation time: {{ $value | humanizeDuration }}
            User experience degraded.
          runbook_url: 'https://docs.medicalcor.ro/runbooks/case-creation-slow'

      - alert: SLOCaseScoringFailures
        expr: |
          (
            sum(rate(osax_case_scoring_total{status="failure"}[5m]))
            /
            sum(rate(osax_case_scoring_total[5m]))
          ) > 0.01
        for: 5m
        labels:
          severity: warning
          slo: case_scoring_success
          slo_target: '99%'
          team: backend
        annotations:
          summary: 'Case scoring failure rate >1%'
          description: |
            Scoring failure rate: {{ $value | humanizePercentage }}
            Clinical workflow may be impacted.
          runbook_url: 'https://docs.medicalcor.ro/runbooks/scoring-failures'

      # ============================================================================
      # AI/ML SLO
      # ============================================================================

      - alert: SLOEmbeddingGenerationSlow
        expr: |
          histogram_quantile(0.95,
            sum(rate(osax_embedding_generation_duration_seconds_bucket[5m])) by (le)
          ) > 10
        for: 10m
        labels:
          severity: warning
          slo: embedding_latency
          slo_target: '10s'
          team: ml
        annotations:
          summary: 'Embedding generation P95 >10s'
          description: |
            P95 embedding generation time: {{ $value | humanizeDuration }}
            Semantic search may be impacted.
          runbook_url: 'https://docs.medicalcor.ro/runbooks/embedding-slow'

      - alert: SLOOpenAIAPIErrors
        expr: |
          (
            sum(rate(osax_openai_requests_total{status="error"}[5m]))
            /
            sum(rate(osax_openai_requests_total[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: warning
          slo: openai_success
          slo_target: '95%'
          team: ml
        annotations:
          summary: 'OpenAI API error rate >5%'
          description: |
            API error rate: {{ $value | humanizePercentage }}
            AI features may be degraded.
          runbook_url: 'https://docs.medicalcor.ro/runbooks/openai-errors'
