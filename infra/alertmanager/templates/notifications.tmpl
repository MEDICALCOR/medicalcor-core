{{/* Slack Templates */}}

{{ define "slack.critical.text" }}
{{ range .Alerts }}
*Alert:* {{ .Labels.alertname }}
*Severity:* {{ .Labels.severity | toUpper }}
*Service:* {{ .Labels.service | default "unknown" }}
*Status:* {{ .Status | toUpper }}

*Summary:* {{ .Annotations.summary }}
*Description:* {{ .Annotations.description }}

*Started:* {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
{{ if .EndsAt }}*Resolved:* {{ .EndsAt.Format "2006-01-02 15:04:05 MST" }}{{ end }}

*Labels:*
{{ range .Labels.SortedPairs }}‚Ä¢ {{ .Name }}: {{ .Value }}
{{ end }}
{{ if .Annotations.runbook_url }}*Runbook:* {{ .Annotations.runbook_url }}{{ end }}
---
{{ end }}
{{ end }}

{{ define "slack.warning.text" }}
{{ range .Alerts }}
*Alert:* {{ .Labels.alertname }}
*Service:* {{ .Labels.service | default "unknown" }}
*Status:* {{ .Status }}

{{ .Annotations.summary }}
{{ if .Annotations.description }}> {{ .Annotations.description }}{{ end }}

Started: {{ .StartsAt.Format "15:04:05 MST" }}
{{ if .Annotations.runbook_url }}<{{ .Annotations.runbook_url }}|Runbook>{{ end }}
---
{{ end }}
{{ end }}

{{ define "slack.business.text" }}
{{ range .Alerts }}
üìä *{{ .Labels.alertname }}*

{{ .Annotations.summary }}

*Impact:* {{ .Annotations.description | default "See details in Grafana" }}
*Time:* {{ .StartsAt.Format "15:04 MST" }}

{{ if eq .Labels.alertname "NoLeadsScored" }}
‚ö†Ô∏è Lead scoring pipeline may be stalled. Check:
‚Ä¢ OpenAI API status
‚Ä¢ Database connectivity
‚Ä¢ Background job queue
{{ end }}

{{ if eq .Labels.alertname "UnusualHotLeadVolume" }}
üìà Unusual spike in hot leads. Possible causes:
‚Ä¢ Marketing campaign surge
‚Ä¢ Data quality issue
‚Ä¢ Scoring model drift
{{ end }}
---
{{ end }}
{{ end }}

{{ define "slack.ai.text" }}
{{ range .Alerts }}
ü§ñ *{{ .Labels.alertname }}*

{{ .Annotations.summary }}

{{ if eq .Labels.alertname "AIServiceDegraded" }}
*Fallback Status:* AI scoring falling back to rule-based system
*Action Required:* Check OpenAI API status and rate limits
{{ end }}

{{ if eq .Labels.alertname "AIScoringSlow" }}
*Latency Issue:* Scoring P95 latency exceeds 10 seconds
*Possible Causes:*
‚Ä¢ OpenAI API latency
‚Ä¢ Database query performance
‚Ä¢ Network issues
{{ end }}

Started: {{ .StartsAt.Format "15:04:05 MST" }}
---
{{ end }}
{{ end }}

{{ define "slack.infra.text" }}
{{ range .Alerts }}
üîß *{{ .Labels.alertname }}* - {{ .Labels.severity | toUpper }}

{{ .Annotations.summary }}

{{ if eq .Labels.alertname "RedisDown" }}
üî¥ *CRITICAL:* Redis cache is unreachable
*Impact:* Rate limiting disabled, session storage affected
*Immediate Actions:*
1. Check Redis container/service status
2. Verify network connectivity
3. Check Redis memory usage
{{ end }}

{{ if eq .Labels.alertname "HighMemoryUsage" }}
‚ö†Ô∏è *WARNING:* Memory usage above 90%
*Host:* {{ .Labels.instance }}
*Current:* {{ .Labels.value }}%
*Actions:*
1. Check for memory leaks
2. Consider scaling horizontally
3. Review recent deployments
{{ end }}

{{ if eq .Labels.alertname "LowDiskSpace" }}
‚ö†Ô∏è *WARNING:* Disk space below 10%
*Host:* {{ .Labels.instance }}
*Actions:*
1. Clean up old logs/backups
2. Expand storage
3. Review log rotation
{{ end }}

Started: {{ .StartsAt.Format "15:04:05 MST" }}
---
{{ end }}
{{ end }}

{{/* PagerDuty Templates */}}

{{ define "pagerduty.description" }}
[{{ .Status | toUpper }}] {{ .GroupLabels.alertname }}: {{ (index .Alerts 0).Annotations.summary }}
{{ end }}

{{ define "pagerduty.firing" }}
{{ range .Alerts }}
Alert: {{ .Labels.alertname }}
Service: {{ .Labels.service }}
Summary: {{ .Annotations.summary }}
Description: {{ .Annotations.description }}
Started: {{ .StartsAt }}
{{ end }}
{{ end }}

{{/* Email Templates */}}

{{ define "email.default.subject" }}
[{{ .Status | toUpper }}] {{ .GroupLabels.alertname }} - MedicalCor Alert
{{ end }}

{{ define "email.default.html" }}
<!DOCTYPE html>
<html>
<head>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .alert { padding: 16px; margin: 16px 0; border-radius: 8px; }
    .critical { background: #fee; border-left: 4px solid #e53e3e; }
    .warning { background: #fef3c7; border-left: 4px solid #f59e0b; }
    .resolved { background: #d1fae5; border-left: 4px solid #10b981; }
    .label { display: inline-block; padding: 2px 8px; border-radius: 4px; background: #e2e8f0; margin: 2px; }
  </style>
</head>
<body>
  <h1>MedicalCor Alert Notification</h1>
  <p>Status: <strong>{{ .Status | toUpper }}</strong></p>

  {{ range .Alerts }}
  <div class="alert {{ if eq $.Status "resolved" }}resolved{{ else }}{{ .Labels.severity }}{{ end }}">
    <h2>{{ .Labels.alertname }}</h2>
    <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
    <p><strong>Description:</strong> {{ .Annotations.description }}</p>
    <p><strong>Service:</strong> {{ .Labels.service | default "N/A" }}</p>
    <p><strong>Started:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}</p>
    {{ if .EndsAt }}<p><strong>Resolved:</strong> {{ .EndsAt.Format "2006-01-02 15:04:05 MST" }}</p>{{ end }}

    <p><strong>Labels:</strong></p>
    {{ range .Labels.SortedPairs }}
    <span class="label">{{ .Name }}: {{ .Value }}</span>
    {{ end }}

    {{ if .Annotations.runbook_url }}
    <p><a href="{{ .Annotations.runbook_url }}">View Runbook</a></p>
    {{ end }}
  </div>
  {{ end }}

  <hr>
  <p style="color: #666; font-size: 12px;">
    This alert was generated by MedicalCor AlertManager<br>
    <a href="https://grafana.medicalcor.io">View in Grafana</a>
  </p>
</body>
</html>
{{ end }}
